\documentclass{scrartcl}

\usepackage{listings}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{tabularx}
\usepackage{ragged2e}
\usepackage{hyperref}

\usepackage{syntax}

\DeclareMathOperator{\apply}{apply}
\DeclareMathOperator{\ifop}{if}
\DeclareMathOperator{\thenop}{then}
\DeclareMathOperator{\elseop}{else}
\DeclareMathOperator{\checkop}{check}
\DeclareMathOperator{\fby}{fby}
\DeclareMathOperator{\where}{where}
\DeclareMathOperator{\choke}{choke}
\DeclareMathOperator{\foreach}{\mathbf{foreach}}

\DeclareMathOperator{\ident}{\mathbf{ident}}

\DeclareMathOperator{\ite}{ite}
\DeclareMathOperator{\nextop}{next}
\DeclareMathOperator{\num}{num}
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\bool}{bool}

\DeclareMathOperator{\compat}{\mathbf{compat}}
\DeclareMathOperator{\canon}{\mathbf{canon}}

\DeclareMathOperator{\numtype}{\mathbb{R}}

\DeclareMathOperator{\gtypes}{\Delta}

\DeclareMathOperator{\ceval}{\overset{C}{\smash{\Downarrow}}}

\makeindex

\begin{document}
    \title{Pixy formal semantics}
    \author{A. Finn Hackett, Reed Mullanix}
    \maketitle
    
    \section{Term language}
    
    \begin{grammar}
        <expr> ::= <number>
            \alt <var>
            \alt "nil"
            \alt "?" <expr>
            \alt "if" <expr> "then" <expr> "else" <expr>
            \alt <expr> "fby" <expr>
            \alt <expr> "where" <wheredecls>
            \alt "next" <expr>
            \alt <var> "(" <exprlist> ")"
            \alt <expr> "+" <expr>
            \alt <expr> "-" <expr>
            \alt <expr> "*" <expr>
            \alt <expr> "/" <expr>
            \alt <expr> ".." <expr>
            \alt "(" <exprlist> ")"
            \alt "len" <expr>
            \alt "[" <exprlist> "]" <expr> 
        
        <exprlist> ::= <expr> "," <exprlist> | <expr>
        
        <varlist> ::= <var> "," <varlist> | <var>
        
        <wheredecl> ::= <var> "=" <expr> 
            \alt <var> "(" <varlist> ")" "=" <expr>
            \alt "(" <varlist> ")" "=" <expr>
            
        <wheredecls> ::= <wheredecl>; <wheredecls> | <wheredecl>
    \end{grammar}

    \section{Init rules}
    
    \begin{align*}
    \frac{
        F \vdash E \overset{init}{\Rightarrow} S
    }{
        F \vdash ?E \overset{init}{\Rightarrow} S
    }[\mathtt{Init-check}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F \vdash L \overset{init}{\Rightarrow} S_l \\
        F \vdash R \overset{init}{\Rightarrow} S_r
        \end{matrix}
    }{
        F \vdash L \fby R \overset{init}{\Rightarrow} false, S_l, S_r
    }[\mathtt{Init-fby}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F \vdash C \overset{init}{\Rightarrow} S_c \\
        F \vdash T \overset{init}{\Rightarrow} S_t \\
        F \vdash F \overset{init}{\Rightarrow} S_f
        \end{matrix}
    }{
        F \vdash \ifop C \thenop T \elseop F \overset{init}{\Rightarrow} S_c, S_t, S_f
    }[\mathtt{Init-ite}]
    \end{align*}
    
    \begin{align*}
    \frac{
        F \vdash E \overset{init}{\Rightarrow} S
    }{
        F \vdash \nextop E \overset{init}{\Rightarrow} false, S
    }[\mathtt{Init-next}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F \vdash E_n \overset{wheredecl}{\Rightarrow} F'
        \end{matrix}
    }{
        F \vdash n = E; E_n \overset{wheredecl}{\Rightarrow} F'
    }[\mathtt{WhereInit-v-decl}]
    \end{align*}
    
    \begin{align*}
    \frac{
        F \vdash E_n \overset{wheredecl}{\Rightarrow} F'
    }{
        F \vdash f(A) = E; E_n \overset{wheredecl}{\Rightarrow} f \to \left<A, E \right>, F'
    }[\mathtt{WhereInit-fn-decl}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        F \vdash \overset{wheredecl}{\Rightarrow} F
    }[\mathtt{WhereInit-empty-decl}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F \vdash E \overset{init}{\Rightarrow} s \\
        F \vdash E_n \overset{whereinit}{\Rightarrow} S
        \end{matrix}
    }{
        F \vdash n = E; E_n \overset{whereinit}{\Rightarrow} \left<nil, s\right>, S
    }[\mathtt{WhereInit-v-init}]
    \end{align*}
    
    \begin{align*}
    \frac{
        F \vdash E_n \overset{whereinit}{\Rightarrow} S
    }{
        F \vdash f(A) = E; E_n \overset{whereinit}{\Rightarrow} S
    }[\mathtt{WhereInit-fn-init}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        F \vdash \overset{whereinit}{\Rightarrow} \emptyset
    }[\mathtt{WhereInit-empty-init}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F \vdash E_s \overset{wheredecl}{\Rightarrow} F' \\
        F' \vdash E \overset{init}{\Rightarrow} S_e \\
        F' \vdash E_s \overset{whereinit}{\Rightarrow} S
        \end{matrix}
    }{
        F \vdash E \where E_s \overset{init}{\Rightarrow} S_e, S
    }[\mathtt{Init-where}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F \vdash A \overset{init}{\Rightarrow} S \\
        F \vdash A_n \overset{applyinit}{\Rightarrow} S_n
        \end{matrix}
    }{
        F \vdash A, A_n \overset{applyinit}{\Rightarrow} S, S_n
    }[\mathtt{ApplyInit-arg}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        F \vdash \overset{applyinit}{\Rightarrow} \emptyset
    }[\mathtt{ApplyInit-empty}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F(f) = \left< \_, E \right> \\
        F \vdash E \overset{init}{\Rightarrow} S_e \\
        F \vdash A \overset{applyinit}{\Rightarrow} S
        \end{matrix}
    }{
        F \vdash f(A) \overset{init}{\Rightarrow} S_e, S
    }[\mathtt{Init-apply}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        F \vdash \_ \overset{init}{\Rightarrow} \emptyset
    }[\mathtt{Init-literal}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F \vdash L \overset{init}{\Rightarrow} S_l \\
        F \vdash R \overset{init}{\Rightarrow} S_r
        \end{matrix}
    }{
        F \vdash L \enspace \_ \enspace R \overset{init}{\Rightarrow} S_l, S_r
    }[\mathtt{Init-binop}]
    \end{align*}
    
    \section{Data type sizing}
    
    

    \section{Evaluation rules}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E \Downarrow V; S' \\
        V \neq nil
        \end{matrix}
    }{
        S; F; M \vdash ?E \Downarrow true; S'
    }[\mathtt{Eval-check-true}]
    \end{align*}
    
    \begin{align*}
    \frac{
        S; F; M \vdash E \Downarrow nil; S'
    }{
        S; F; M \vdash ?E \Downarrow false; S'
    }[\mathtt{Eval-check-false}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_c; F; M \vdash C \Downarrow true; S_c' \\
        S_t; F; M \vdash T \Downarrow V; S_t' \\
        S_f; F; M \vdash F \ceval nil; S_f'
        \end{matrix}
    }{
        S_c, S_t, S_f; F; M \vdash \ifop C \thenop T \elseop F \Downarrow V; S_c', S_t', S_f'
    }[\mathtt{Eval-ite-true}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_c; F; M \vdash C \Downarrow false; S_c' \\
        S_t; F; M \vdash T  \ceval nil; S_t' \\
        S_f; F; M \vdash F \Downarrow V; S_f'
        \end{matrix}
    }{
        S_c, S_t, S_f; F; M \vdash \ifop C \thenop T \elseop F \Downarrow V; S_c', S_t', S_f'
    }[\mathtt{Eval-ite-false}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_c; F; M \vdash C \Downarrow nil; S_c' \\
        S_t; F; M \vdash T  \ceval nil; S_t' \\
        S_f; F; M \vdash F  \ceval nil; S_f'
        \end{matrix}
    }{
        S_c, S_t, S_f; F; M \vdash \ifop C \thenop T \elseop F \Downarrow nil; S_c', S_t', S_f'
    }[\mathtt{Eval-ite-nil}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_c; F; M \vdash C  \ceval nil; S_c' \\
        S_t; F; M \vdash T  \ceval nil; S_t' \\
        S_f; F; M \vdash F  \ceval nil; S_f'
        \end{matrix}
    }{
        S_c, S_t, S_f; F; M \vdash \ifop C \thenop T \elseop F  \ceval nil; S_c', S_t', S_f'
    }[\mathtt{Eval-ite-C}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_l; F; M \vdash E_l \Downarrow V; S_l' \\
        V \neq nil \\
        S_r; F; M \vdash E_r  \ceval nil; S_r'
        \end{matrix}
    }{
        false, S_l, S_r; F; M \vdash E_l \fby E_r \Downarrow V; true, S_l', S_r'
    }[\mathtt{Eval-fby-before}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_l; F; M \vdash E_l \Downarrow nil; S_l' \\
        S_r; F; M \vdash E_r  \ceval nil; S_r'
        \end{matrix}
    }{
        false, S_l, S_r; F; M \vdash E_l \fby E_r \Downarrow nil; false, S_l', S_r'
    }[\mathtt{Eval-fby-before-nil}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_l; F; M \vdash E_l  \ceval nil; S_l' \\
        S_r; F; M \vdash E_r \Downarrow V; S_r'
        \end{matrix}
    }{
        true, S_l, S_r; F; M \vdash E_l \fby E_r \Downarrow V; true, S_l', S_r'
    }[\mathtt{Eval-fby-after}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_l; F; M \vdash E_l  \ceval nil; S_l' \\
        S_r; F; M \vdash E_r  \ceval nil; S_r'
        \end{matrix}
    }{
        c, S_l, S_r; F; M \vdash E_l \fby E_r \Downarrow nil; c, S_l', S_r'
    }[\mathtt{Eval-fby-C}]
    \end{align*}
    
    \begin{align*}
    \frac{
        S_n; F; M \vdash E_n \overset{names}{\Rightarrow} F'; M'
    }{
        \left<v, \_ \right>, S_n; F; M \vdash n = E; E_n \overset{names}{\Rightarrow} F'; n \to v, M'
    }[\mathtt{WhereNames-v-decl}]
    \end{align*}
    
    \begin{align*}
    \frac{
        S; f \to \left< A, E \right >, F; M \vdash E_v \overset{names}{\Rightarrow} F'; M'
    }{
        S; F; M \vdash f(A) = E; E_n \overset{names}{\Rightarrow} F'; M'
    }[\mathtt{WhereNames-fn-decl}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        \emptyset; F; M \vdash \overset{names}{\Rightarrow} F'; M'
    }[\mathtt{WhereNames-empty}]
    \end{align*}
    
    \begin{align*}
    \frac{
        s; F; M \vdash E \Downarrow v; s'
        S_n; F; M \vdash E_n \overset{values}{\Rightarrow} S_n'
    }{
        \left<\_, s\right>, S_n; F; M \vdash n = E; E_n \overset{values}{\Rightarrow} \left<v, s'\right>, S_n'
    }[\mathtt{WhereVal-v-decl}]
    \end{align*}
    
    \begin{align*}
    \frac{
        S; F; M \vdash E_n \overset{values}{\Rightarrow} S'
    }{
        S; F; M \vdash f(A) = E; E_n \overset{values}{\Rightarrow} S'
    }[\mathtt{WhereVal-fn-decl}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        \emptyset; F; M \vdash \overset{values}{\Rightarrow} \emptyset
    }[\mathtt{WhereVal-empty}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E_s \overset{names}{\Rightarrow} F_i; M_i \\
        S; F_i; M_i \vdash E_s \overset{values}{\Rightarrow} S' \\
        S_e; F_i; M_i \vdash E \Downarrow V; S_e'        
        \end{matrix}
    }{
        S_e, S; F; M \vdash E \where E_s \Downarrow V; S_e', S'
    }[\mathtt{Eval-where}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E_s \overset{names}{\Rightarrow} F_i; M_i \\
        S; F_i; M_i \vdash E_s \overset{values}{\Rightarrow} S' \\
        S_e; F_i; M_i \vdash E  \ceval nil; S_e'        
        \end{matrix}
    }{
        S_e, S; F; M \vdash E \where E_s \ceval nil; S_e', S'
    }[\mathtt{Eval-where-C}]
    \end{align*}
   
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E \Downarrow V; S' \\
        V \neq nil
        \end{matrix}
    }{
        \left<false, nil \right>, S; F; M \vdash \nextop E \Downarrow nil; \left< true, V \right>, S'
    }[\mathtt{Eval-next-before}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E \Downarrow nil; S' \\
        \end{matrix}
    }{
        \left<false, nil \right>, S; F; M \vdash \nextop E \Downarrow nil; \left< false, nil \right>, S'
    }[\mathtt{Eval-next-before-nil}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        v \neq nil \\
        S; F; M \vdash E \Downarrow V; S'
        \end{matrix}
    }{
        \left<true, v \right>, S; F; M \vdash \nextop E  \Downarrow v; \left< true, V \right>, S'
    }[\mathtt{Eval-next-after}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E \Downarrow V; S'
        \end{matrix}
    }{
        \left<true, nil \right>, S; F; M \vdash \nextop E  \Downarrow V; \left< true, nil \right>, S'
    }[\mathtt{Eval-next-after-nil}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E \ceval nil; S'
        \end{matrix}
    }{
        \left<c, v\right>, S; F; M \vdash \nextop E   \ceval nil; \left<c, v\right>, S'
    }[\mathtt{Eval-next-C}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        \emptyset; F; M \vdash nil \Downarrow nil; \emptyset
    }[\mathtt{Eval-nil}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        \emptyset; F; M \vdash nil  \ceval nil; \emptyset
    }[\mathtt{Eval-nil-C}]
    \end{align*}
    
    \begin{align*}
    \frac{
        N \in \numtype
    }{
        \emptyset; F; M \vdash N \Downarrow N; \emptyset
    }[\mathtt{Eval-num}]
    \end{align*}
    
    \begin{align*}
    \frac{
        N \in \numtype
    }{
        \emptyset; F; M \vdash N  \ceval nil; \emptyset
    }[\mathtt{Eval-num-C}]
    \end{align*}

    \begin{align*}
    \frac{
        M(I) = V
    }{
        \emptyset; F; M \vdash I \Downarrow V; \emptyset
    }[\mathtt{Eval-id}]
    \end{align*}
    
    \begin{align*}
    \frac{
        M(I) = V
    }{
        \emptyset; F; M \vdash I  \ceval nil; \emptyset
    }[\mathtt{Eval-id-C}]
    \end{align*}
    
    \begin{align*}
    \frac{
        E \in \{true, false\}
    }{
        \emptyset; F; M \vdash E \Downarrow E; \emptyset
    }[\mathtt{Eval-boolean}]
    \end{align*}
    
    \begin{align*}
    \frac{
        E \in \{true, false\}
    }{
        \emptyset; F; M \vdash E  \ceval nil; \emptyset
    }[\mathtt{Eval-boolean-C}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E \Downarrow V; S' \\
        A_n; S_n; F; M \vdash E_n \overset{arg}{\Rightarrow} M_i; S_n'
        \end{matrix}
    }{
        A, A_n; S, S_n; F; M \vdash E, E_n \overset{arg}{\Rightarrow} A \to V, M_i; S', S_n'
    }[\mathtt{Apply-arg}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        \emptyset; \emptyset; F; M \vdash \overset{arg}{\Rightarrow} \emptyset; \emptyset
    }[\mathtt{Apply-arg-empty}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S; F; M \vdash E  \ceval nil; S' \\
        A_n; S_n; F; M \vdash E_n \overset{argC}{\Rightarrow} M_i; S_n'
        \end{matrix}
    }{
        A, A_n; S, S_n; F; M \vdash E, E_n \overset{argC}{\Rightarrow} A \to nil, M_i; S', S_n'
    }[\mathtt{Apply-arg-C}]
    \end{align*}
    
    \begin{align*}
    \frac{}{
        \emptyset; \emptyset; F; M \vdash \overset{argC}{\Rightarrow} \emptyset; \emptyset
    }[\mathtt{Apply-arg-empty-C}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F(f) = \left< A, E \right> \\
        A; S; F; M \vdash a \overset{arg}{\Rightarrow} M_i; S' \\
        S_e; F; M_i \vdash E \Downarrow V; S_e'
        \end{matrix}
    }{
        S_e, S; F; M \vdash f(a) \Downarrow V; S_e', S'
    }[\mathtt{Eval-apply}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        F(f) = \left< A, E \right> \\
        A; S; F; M \vdash a \overset{argC}{\Rightarrow} M_i; S' \\
        S_e; F; M_i \vdash E  \ceval nil; S_e'
        \end{matrix}
    }{
        S_e, S; F; M \vdash f(a) \Downarrow nil; S_e', S'
    }[\mathtt{Eval-apply-C}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        L, R \in \numtype \\
        V = L + R
        \end{matrix}
    }{
        L + R \overset{binop}{\Rightarrow} V
    }[\mathtt{Binop-plus}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        L, R \in \numtype \\
        V = L - R
        \end{matrix}
    }{
        L - R \overset{binop}{\Rightarrow} V
    }[\mathtt{Binop-minus}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        L, R \in \numtype \\
        V = L * R
        \end{matrix}
    }{
        L * R \overset{binop}{\Rightarrow} V
    }[\mathtt{Binop-times}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        L, R \in \numtype \\
        V = L / R
        \end{matrix}
    }{
        L / R \overset{binop}{\Rightarrow} V
    }[\mathtt{Binop-divide}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_l; F; M \vdash L_e \Downarrow L_v; S_l' \\
        S_r; F; M \vdash R_e \Downarrow R_v; S_l' \\
        L_v \enspace B \enspace R_v \overset{binop}{\Rightarrow} V
        \end{matrix}
    }{
        S_l, S_r; F; M \vdash L_e \enspace B \enspace R_e \Downarrow V; S_l', S_r'
    }[\mathtt{Eval-binop}]
    \end{align*}
    
    \begin{align*}
    \frac{
        \begin{matrix}
        S_l; F; M \vdash L_e  \ceval nil; S_l' \\
        S_r; F; M \vdash R_e  \ceval nil; S_l' \\
        \end{matrix}
    }{
        S_l, S_r; F; M \vdash L_e \enspace B \enspace R_e  \ceval nil; S_l', S_r'
    }[\mathtt{Eval-binop-C}]
    \end{align*}
    
\end{document}